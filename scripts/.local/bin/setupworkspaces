#!/bin/bash

# i3 workspace setup using append_layout for reliable window placement
#
# Prerequisites:
# - ~/.config/i3/config must include: include ~/.config/i3/workspace-assigns.conf
# - Run: i3-msg reload (or restart i3) after first setup

# =============================================================================
# CONFIGURATION
# =============================================================================

TERMINAL="gnome-terminal"
LAYOUT_DIR="$HOME/.config/i3/layouts"
MONITOR_CONF="$HOME/.config/i3/workspace-monitors.conf"

TERM_PATH_TOP_LEFT="$HOME/lelloprojects"
TERM_PATH_TOP_RIGHT="$HOME/lelloprojects"
TERM_PATH_BOTTOM_LEFT="$HOME/lelloprojects"
TERM_PATH_BOTTOM_RIGHT="$HOME/lelloprojects"

# Monitor assignments - which workspaces go to which monitor
# Find your monitor names with: xrandr --query | grep connected
# Format: "WS_NUM:MONITOR_NAME" (space-separated pairs)
# Leave empty to skip monitor assignment
MONITOR_ASSIGNMENTS="1:DP-0 2:DP-0 31:HDMI-0 32:HDMI-0 33:HDMI-0 34:HDMI-0 4:DP-0 5:DP-0 6:DP-0"

# =============================================================================
# MONITOR FUNCTIONS
# =============================================================================

write_monitor_bindings() {
    if [ -z "$MONITOR_ASSIGNMENTS" ]; then
        return 0
    fi

    echo "Configuring workspace-to-monitor bindings..."
    echo "# Workspace to monitor bindings (auto-generated by setupworkspaces)" > "$MONITOR_CONF"
    echo "# Generated: $(date)" >> "$MONITOR_CONF"

    for pair in $MONITOR_ASSIGNMENTS; do
        local ws="${pair%%:*}"
        local monitor="${pair#*:}"
        echo "  Workspace $ws -> $monitor"
        echo "workspace \"$ws\" output $monitor" >> "$MONITOR_CONF"
    done

    # Reload i3 to apply changes
    i3-msg reload >/dev/null
}

# =============================================================================
# WORKSPACE SETUP FUNCTIONS
# =============================================================================

setup_terminal_grid() {
    local ws="$1"

    echo "  Workspace $ws: loading 2x2 layout..."
    i3-msg "workspace $ws" >/dev/null
    i3-msg "append_layout $LAYOUT_DIR/terminals-2x2.json" >/dev/null

    # Launch 4 terminals - they get swallowed into layout placeholders
    $TERMINAL --working-directory="$TERM_PATH_TOP_LEFT" &
    $TERMINAL --working-directory="$TERM_PATH_TOP_RIGHT" &
    $TERMINAL --working-directory="$TERM_PATH_BOTTOM_LEFT" &
    $TERMINAL --working-directory="$TERM_PATH_BOTTOM_RIGHT" &

    sleep 1
}

setup_terminal_2col() {
    local ws="$1"

    echo "  Workspace $ws: loading 2-column layout..."
    i3-msg "workspace $ws" >/dev/null
    i3-msg "append_layout $LAYOUT_DIR/terminals-side-by-side.json" >/dev/null

    # Launch 2 terminals - they get swallowed into layout placeholders
    $TERMINAL --working-directory="$TERM_PATH_TOP_LEFT" &
    $TERMINAL --working-directory="$TERM_PATH_BOTTOM_LEFT" &

    sleep 1
}

# =============================================================================
# MAIN
# =============================================================================

main() {
    # Check layout files exist
    if [ ! -f "$LAYOUT_DIR/terminals-2x2.json" ]; then
        echo "Error: Missing $LAYOUT_DIR/terminals-2x2.json"
        exit 1
    fi

    # Configure monitor bindings
    write_monitor_bindings

    echo "Launching main applications (assign rules handle placement)..."
    echo "  Chromium -> workspace 1"
    chromium &

    echo "  VS Code -> workspace 2"
    code &

    echo "Setting up terminal workspaces (31, 32, 33, 34, 4, 5, 6)..."
    setup_terminal_grid 31
    setup_terminal_grid 32
    setup_terminal_grid 33
    setup_terminal_grid 34
    setup_terminal_grid 4

    echo "  Android Studio -> workspace 5"
    /home/lelloman/android-studio/bin/studio &

    setup_terminal_2col 6

    i3-msg "workspace 1" >/dev/null
    echo "Done!"
}

main "$@"
